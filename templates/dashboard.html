{% extends "base.html" %}

{% block title %}Dashboard - Google Indexing Pipeline{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-tachometer-alt me-2"></i>
            Indexing Dashboard
        </h1>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-2">
        <div class="card">
            <div class="card-body text-center">
                <h3 class="text-primary">{{ stats.total_urls }}</h3>
                <p class="small text-muted mb-0">Total URLs</p>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card">
            <div class="card-body text-center">
                <h3 class="text-success">{{ stats.indexed_urls }}</h3>
                <p class="small text-muted mb-0">Indexed</p>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card">
            <div class="card-body text-center">
                <h3 class="text-info">{{ stats.ready_urls }}</h3>
                <p class="small text-muted mb-0">Ready</p>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card">
            <div class="card-body text-center">
                <h3 class="text-warning">{{ stats.pending_urls }}</h3>
                <p class="small text-muted mb-0">Pending</p>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card">
            <div class="card-body text-center">
                <h3 class="text-danger">{{ stats.error_urls }}</h3>
                <p class="small text-muted mb-0">Errors</p>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card border-success">
            <div class="card-body text-center">
                <h3 class="text-success">{{ stats.indexing_rate }}%</h3>
                <p class="small text-muted mb-0">Index Rate</p>
            </div>
        </div>
    </div>
</div>

<!-- Charts and Analytics -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-line me-2"></i>Daily Indexing Trends</h5>
            </div>
            <div class="card-body">
                <canvas id="indexingChart" height="100"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-pie me-2"></i>URL Status Distribution</h5>
            </div>
            <div class="card-body">
                <canvas id="statusChart" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-bolt me-2"></i>Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-2">
                        <form method="POST" action="{{ url_for('validate_urls') }}" class="d-inline">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-search me-1"></i>
                                Validate URLs
                            </button>
                        </form>
                    </div>
                    <div class="col-md-2">
                        <form method="POST" action="{{ url_for('generate_sitemap') }}" class="d-inline">
                            <button type="submit" class="btn btn-success w-100">
                                <i class="fas fa-sitemap me-1"></i>
                                Generate Sitemap
                            </button>
                        </form>
                    </div>
                    <div class="col-md-2">
                        <button type="button" class="btn btn-info w-100" id="harvestGSCBtn">
                            <i class="fas fa-download me-1"></i>
                            Harvest GSC
                        </button>
                    </div>
                    <div class="col-md-2">
                        <button type="button" class="btn btn-warning w-100" id="startAdvancedIndexingBtn">
                            <i class="fas fa-rocket me-1"></i>
                            6-Layer Campaign
                        </button>
                    </div>
                    <div class="col-md-2">
                        <button type="button" class="btn btn-secondary w-100" id="processTasksBtn">
                            <i class="fas fa-cogs me-1"></i>
                            Process Tasks
                        </button>
                    </div>
                    <div class="col-md-2">
                        <a href="{{ url_for('urls') }}" class="btn btn-outline-primary w-100">
                            <i class="fas fa-plus me-1"></i>
                            Add URLs
                        </a>
                    </div>
                </div>
                
                <!-- AI Agent & Analytics Row -->
                <div class="row mt-3">
                    <div class="col-md-3">
                        <button type="button" class="btn btn-info w-100" id="openAIAgentBtn">
                            <i class="fas fa-brain me-1"></i>
                            AI Agent
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button type="button" class="btn btn-secondary w-100" id="openChatbotBtn">
                            <i class="fas fa-comments me-1"></i>
                            AI Chatbot
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button type="button" class="btn btn-success w-100" id="openBacklinkDashboardBtn">
                            <i class="fas fa-link me-1"></i>
                            Backlink Tools
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button type="button" class="btn btn-warning w-100" id="testMLPredictionBtn">
                            <i class="fas fa-chart-line me-1"></i>
                            ML Predictions
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Activity and Errors -->
<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-history me-2"></i>Recent Crawl Activity</h5>
            </div>
            <div class="card-body">
                {% if recent_crawls %}
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>URL</th>
                                    <th>Status</th>
                                    <th>Time</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for crawl in recent_crawls %}
                                <tr>
                                    <td>
                                        <a href="{{ url_for('url_detail', url_id=crawl.url_id) }}" class="text-decoration-none">
                                            {{ crawl.url.url|truncate(50) }}
                                        </a>
                                    </td>
                                    <td>
                                        {% if crawl.status_code == 200 %}
                                            <span class="badge bg-success">{{ crawl.status_code }}</span>
                                        {% else %}
                                            <span class="badge bg-danger">{{ crawl.status_code or 'Error' }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small class="text-muted">
                                            {{ crawl.created_at.strftime('%m/%d %H:%M') }}
                                        </small>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted">No recent crawl activity</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-exclamation-triangle me-2"></i>Common Issues</h5>
            </div>
            <div class="card-body">
                {% if error_summary %}
                    {% for error, count in error_summary %}
                        {% if error %}
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="small">{{ error[:50] }}...</span>
                                <span class="badge bg-danger">{{ count }}</span>
                            </div>
                        {% endif %}
                    {% endfor %}
                {% else %}
                    <p class="text-muted">No common issues found</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Recent Sitemaps -->
{% if recent_sitemaps %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-sitemap me-2"></i>Recent Sitemaps</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Filename</th>
                                <th>URLs</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th>Submitted</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for sitemap in recent_sitemaps %}
                            <tr>
                                <td>{{ sitemap.filename }}</td>
                                <td>{{ sitemap.url_count }}</td>
                                <td>
                                    {% if sitemap.submission_status == 'submitted' %}
                                        <span class="badge bg-success">Submitted</span>
                                    {% elif sitemap.submission_status == 'pending' %}
                                        <span class="badge bg-warning">Pending</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ sitemap.submission_status|title }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <small class="text-muted">
                                        {{ sitemap.created_at.strftime('%m/%d %H:%M') }}
                                    </small>
                                </td>
                                <td>
                                    {% if sitemap.submitted_at %}
                                        <small class="text-muted">
                                            {{ sitemap.submitted_at.strftime('%m/%d %H:%M') }}
                                        </small>
                                    {% else %}
                                        <small class="text-muted">-</small>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
    // Initialize dashboard when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Initializing Google Indexing Pipeline Dashboard');
        
        // Safely parse JSON data with fallbacks
        let dailyStats = [];
        let statsData = {
            indexed_urls: 0,
            ready_urls: 0,
            pending_urls: 0,
            error_urls: 0
        };
        
        {% if daily_stats %}
            dailyStats = {{ daily_stats|tojson|safe }};
        {% endif %}
        
        {% if stats %}
            statsData = {
                indexed_urls: {{ stats.indexed_urls or 0 }},
                ready_urls: {{ stats.ready_urls or 0 }},
                pending_urls: {{ stats.pending_urls or 0 }},
                error_urls: {{ stats.error_urls or 0 }}
            };
        {% endif %}
        
        // Status distribution chart
        const statusCtx = document.getElementById('statusChart');
        if (statusCtx) {
            new Chart(statusCtx.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: ['Indexed', 'Ready', 'Pending', 'Error'],
                    datasets: [{
                        data: [
                            statsData.indexed_urls,
                            statsData.ready_urls,
                            statsData.pending_urls,
                            statsData.error_urls
                        ],
                        backgroundColor: [
                            'var(--bs-success)',
                            'var(--bs-info)',
                            'var(--bs-warning)',
                            'var(--bs-danger)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        // Daily trends chart
        const indexingCtx = document.getElementById('indexingChart');
        if (indexingCtx && dailyStats && dailyStats.length > 0) {
            const dates = dailyStats.map(stat => stat.date || '');
            const totalUrls = dailyStats.map(stat => stat.total_urls || 0);
            const indexedUrls = dailyStats.map(stat => stat.indexed_urls || 0);
            
            new Chart(indexingCtx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Total URLs',
                        data: totalUrls,
                        borderColor: 'var(--bs-primary)',
                        backgroundColor: 'transparent',
                        tension: 0.4
                    }, {
                        label: 'Indexed URLs',
                        data: indexedUrls,
                        borderColor: 'var(--bs-success)',
                        backgroundColor: 'transparent',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        // Set up dashboard event listeners
        // Harvest GSC button
        const harvestBtn = document.getElementById('harvestGSCBtn');
        if (harvestBtn) {
            harvestBtn.addEventListener('click', harvestGSCFeedback);
        }
        
        // Advanced indexing button
        const advancedBtn = document.getElementById('startAdvancedIndexingBtn');
        if (advancedBtn) {
            advancedBtn.addEventListener('click', startAdvancedIndexing);
        }
        
        // Process tasks button
        const processBtn = document.getElementById('processTasksBtn');
        if (processBtn) {
            processBtn.addEventListener('click', processBackgroundTasks);
        }
        
        // AI Agent buttons
        const aiAgentBtn = document.getElementById('openAIAgentBtn');
        if (aiAgentBtn) {
            aiAgentBtn.addEventListener('click', function() {
                if (typeof puterAI !== 'undefined') {
                    puterAI.openAIAnalysisModal();
                } else {
                    showToast('AI Agent is initializing...', 'info');
                }
            });
        }
        
        const chatbotBtn = document.getElementById('openChatbotBtn');
        if (chatbotBtn) {
            chatbotBtn.addEventListener('click', openChatbot);
        }
        
        const backlinkBtn = document.getElementById('openBacklinkDashboardBtn');
        if (backlinkBtn) {
            backlinkBtn.addEventListener('click', openBacklinkDashboard);
        }
        
        const mlBtn = document.getElementById('testMLPredictionBtn');
        if (mlBtn) {
            mlBtn.addEventListener('click', testMLPrediction);
        }
        
        // Auto-refresh stats every 30 seconds
        setInterval(async () => {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();
                
                // Update stat cards
                const cards = document.querySelectorAll('.card-body h3');
                if (cards.length >= 6) {
                    cards[0].textContent = data.total_urls;
                    cards[1].textContent = data.indexed_urls;
                    cards[2].textContent = data.ready_urls;
                    cards[3].textContent = data.pending_urls;
                    cards[4].textContent = data.error_urls;
                    cards[5].textContent = data.indexing_rate + '%';
                }
            } catch (error) {
                console.warn('Failed to refresh stats:', error);
            }
        }, 30000);
    });
    
    // Global function definitions
    async function harvestGSCFeedback() {
        const button = document.getElementById('harvestGSCBtn');
        if (!button) return;
        
        const originalText = button.innerHTML;
        
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Harvesting...';
        button.disabled = true;
        
        try {
            // Queue GSC harvest task
            const response = await fetch('/api/process-tasks', { 
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ task_type: 'harvest_gsc' })
            });
            
            if (response.ok) {
                if (typeof showToast === 'function') {
                    showToast('GSC feedback harvest queued', 'success');
                }
            } else {
                if (typeof showToast === 'function') {
                    showToast('Error queuing GSC harvest', 'error');
                }
            }
        } catch (error) {
            console.error('Error queuing GSC harvest:', error);
            if (typeof showToast === 'function') {
                showToast('Error queuing GSC harvest', 'error');
            }
        } finally {
            button.innerHTML = originalText;
            button.disabled = false;
        }
    }
    
    async function startAdvancedIndexing() {
        const button = document.getElementById('startAdvancedIndexingBtn');
        if (!button) return;
        
        const originalText = button.innerHTML;
        
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Starting Campaign...';
        button.disabled = true;
        
        try {
            const response = await fetch('/api/advanced-indexing', { 
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({})
            });
            
            if (response.ok) {
                const data = await response.json();
                if (typeof showToast === 'function') {
                    showToast('Advanced indexing campaign started', 'success');
                }
            } else {
                if (typeof showToast === 'function') {
                    showToast('Error starting advanced indexing', 'error');
                }
            }
        } catch (error) {
            console.error('Error starting advanced indexing:', error);
            if (typeof showToast === 'function') {
                showToast('Error starting advanced indexing', 'error');
            }
        } finally {
            button.innerHTML = originalText;
            button.disabled = false;
        }
    }
    
    // Additional global functions for new features
    function openChatbot() {
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.id = 'chatbotModal';
        modal.innerHTML = `
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-comments"></i> AI Chatbot Assistant
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div id="chatMessages" style="height: 400px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; margin-bottom: 10px;">
                            <div class="alert alert-info">
                                <strong>AI Assistant:</strong> Hi! I can help you with SEO analysis, content optimization, and indexing strategies. What would you like to know?
                            </div>
                        </div>
                        <div class="input-group">
                            <input type="text" id="chatInput" class="form-control" placeholder="Ask about SEO, indexing, or content analysis...">
                            <button class="btn btn-primary" id="sendChatBtn">Send</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
        
        // Setup chat functionality
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendChatBtn');
        const chatMessages = document.getElementById('chatMessages');
        
        function sendMessage() {
            const message = chatInput.value.trim();
            if (!message) return;
            
            // Add user message
            const userMsg = document.createElement('div');
            userMsg.className = 'alert alert-secondary mb-2';
            userMsg.innerHTML = `<strong>You:</strong> ${message}`;
            chatMessages.appendChild(userMsg);
            
            chatInput.value = '';
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Simulate AI response (in real implementation, use Puter.js AI)
            setTimeout(() => {
                const aiResponse = generateAIResponse(message);
                const aiMsg = document.createElement('div');
                aiMsg.className = 'alert alert-primary mb-2';
                aiMsg.innerHTML = `<strong>AI Assistant:</strong> ${aiResponse}`;
                chatMessages.appendChild(aiMsg);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 1000);
        }
        
        sendBtn.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });
        
        // Clean up when modal is hidden
        modal.addEventListener('hidden.bs.modal', () => {
            modal.remove();
        });
    }
    
    function generateAIResponse(message) {
        const responses = {
            'indexing': 'For better indexing, focus on: 1) Creating XML sitemaps, 2) Internal linking, 3) Social signals, 4) RSS feeds, 5) Web 2.0 properties. Our 6-layer system handles all of these automatically.',
            'seo': 'SEO best practices include: quality content, proper meta tags, fast loading speeds, mobile optimization, and strong backlink profile. I can analyze your URLs for these factors.',
            'backlinks': 'Quality backlinks from authoritative domains help with indexing and rankings. Our system uses social bookmarking, forum commenting, and directory submissions to build natural link profiles.',
            'content': 'High-quality, original content with proper keyword optimization and semantic relevance performs best. I can analyze your content for SEO potential and indexing priority.',
            'default': 'I can help with SEO analysis, content optimization, indexing strategies, and backlink building. Try asking about specific topics like "How to improve indexing?" or "Analyze my content".'
        };
        
        const lowerMsg = message.toLowerCase();
        for (const [key, response] of Object.entries(responses)) {
            if (lowerMsg.includes(key)) {
                return response;
            }
        }
        
        return responses.default;
    }
    
    function openBacklinkDashboard() {
        window.location.href = '/backlink/dashboard';
    }
    
    function testMLPrediction() {
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.id = 'mlModal';
        modal.innerHTML = `
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-chart-line"></i> ML Prediction Engine
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Indexing Success Prediction</h6>
                                <div class="card">
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label class="form-label">URL to Analyze</label>
                                            <input type="url" id="mlUrl" class="form-control" placeholder="https://example.com/page">
                                        </div>
                                        <button class="btn btn-primary" onclick="runMLPrediction()">
                                            <i class="fas fa-brain"></i> Predict Success Rate
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>Prediction Results</h6>
                                <div id="mlResults" class="card">
                                    <div class="card-body">
                                        <p class="text-muted">Enter a URL to see ML predictions</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
        
        // Clean up when modal is hidden
        modal.addEventListener('hidden.bs.modal', () => {
            modal.remove();
        });
    }
    
    window.runMLPrediction = function() {
        const url = document.getElementById('mlUrl').value;
        if (!url) {
            showToast('Please enter a URL', 'warning');
            return;
        }
        
        // Simulate ML prediction (in real implementation, call backend API)
        const results = document.getElementById('mlResults');
        results.innerHTML = `
            <div class="card-body">
                <h6>Prediction for: ${url}</h6>
                <div class="row text-center">
                    <div class="col-6">
                        <h4 class="text-success">${Math.floor(Math.random() * 30) + 70}%</h4>
                        <small>Success Rate</small>
                    </div>
                    <div class="col-6">
                        <h4 class="text-info">${Math.floor(Math.random() * 48) + 24}h</h4>
                        <small>Est. Time</small>
                    </div>
                </div>
                <hr>
                <h6>Recommended Methods:</h6>
                <ul class="list-unstyled">
                    <li><i class="fas fa-check text-success"></i> Social Bookmarking (High Priority)</li>
                    <li><i class="fas fa-check text-success"></i> RSS Distribution (Medium Priority)</li>
                    <li><i class="fas fa-check text-warning"></i> Forum Commenting (Low Priority)</li>
                </ul>
            </div>
        `;
        
        showToast('ML prediction completed', 'success');
    };
    
    // Global functions available to all buttons
    window.harvestGSCFeedback = harvestGSCFeedback;
    window.startAdvancedIndexing = startAdvancedIndexing;
    window.openChatbot = openChatbot;
    window.openBacklinkDashboard = openBacklinkDashboard;
    window.testMLPrediction = testMLPrediction;
</script>
{% endblock %}
