{% extends "base.html" %}

{% block title %}URL Management - Google Indexing Pipeline{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="fas fa-link me-2"></i>
                URL Management
            </h1>
            <div>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addUrlModal">
                    <i class="fas fa-plus me-1"></i>
                    Add URL
                </button>
                <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#bulkAddModal">
                    <i class="fas fa-upload me-1"></i>
                    Bulk Add
                </button>
                <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#discoverModal">
                    <i class="fas fa-search me-1"></i>
                    Discover
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Status Filter Tabs -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <ul class="nav nav-pills">
                    <li class="nav-item">
                        <a class="nav-link {% if not current_status %}active{% endif %}" 
                           href="{{ url_for('urls') }}">
                            All <span class="badge bg-secondary ms-1">{{ status_counts.all }}</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if current_status == 'pending' %}active{% endif %}" 
                           href="{{ url_for('urls', status='pending') }}">
                            Pending <span class="badge bg-warning ms-1">{{ status_counts.pending }}</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if current_status == 'ready' %}active{% endif %}" 
                           href="{{ url_for('urls', status='ready') }}">
                            Ready <span class="badge bg-info ms-1">{{ status_counts.ready }}</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if current_status == 'indexed' %}active{% endif %}" 
                           href="{{ url_for('urls', status='indexed') }}">
                            Indexed <span class="badge bg-success ms-1">{{ status_counts.indexed }}</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if current_status == 'error' %}active{% endif %}" 
                           href="{{ url_for('urls', status='error') }}">
                            Errors <span class="badge bg-danger ms-1">{{ status_counts.error }}</span>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Search and Actions -->
<div class="row mb-4">
    <div class="col-md-6">
        <form method="GET" class="d-flex">
            <input type="hidden" name="status" value="{{ current_status }}">
            <input type="text" class="form-control" name="q" value="{{ search_query }}" 
                   placeholder="Search URLs...">
            <button type="submit" class="btn btn-outline-primary ms-2">
                <i class="fas fa-search"></i>
            </button>
        </form>
    </div>
    <div class="col-md-6 text-end">
        {% if current_status == 'pending' %}
            <form method="POST" action="{{ url_for('validate_urls') }}" class="d-inline">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-check me-1"></i>
                    Validate Selected
                </button>
            </form>
        {% endif %}
        {% if current_status == 'ready' %}
            <form method="POST" action="{{ url_for('generate_sitemap') }}" class="d-inline">
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-sitemap me-1"></i>
                    Generate Sitemap
                </button>
            </form>
        {% endif %}
    </div>
</div>

<!-- URLs Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                {% if urls.items %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th width="5%">
                                        <input type="checkbox" id="selectAll" class="form-check-input">
                                    </th>
                                    <th width="50%">URL</th>
                                    <th width="10%">Status</th>
                                    <th width="15%">Last Checked</th>
                                    <th width="10%">Response</th>
                                    <th width="10%">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for url in urls.items %}
                                <tr>
                                    <td>
                                        <input type="checkbox" class="form-check-input url-checkbox" 
                                               value="{{ url.id }}">
                                    </td>
                                    <td>
                                        <div>
                                            <a href="{{ url_for('url_detail', url_id=url.id) }}" 
                                               class="text-decoration-none">
                                                {{ url.url|truncate(80) }}
                                            </a>
                                            {% if url.title %}
                                                <br>
                                                <small class="text-muted">{{ url.title|truncate(60) }}</small>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        {% if url.status == 'indexed' %}
                                            <span class="badge bg-success">Indexed</span>
                                        {% elif url.status == 'ready' %}
                                            <span class="badge bg-info">Ready</span>
                                        {% elif url.status == 'pending' %}
                                            <span class="badge bg-warning">Pending</span>
                                        {% elif url.status == 'error' %}
                                            <span class="badge bg-danger">Error</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ url.status|title }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if url.last_checked %}
                                            <small class="text-muted">
                                                {{ url.last_checked.strftime('%m/%d/%Y %H:%M') }}
                                            </small>
                                        {% else %}
                                            <small class="text-muted">Never</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if url.latest_crawl %}
                                            {% if url.latest_crawl.status_code == 200 %}
                                                <span class="badge bg-success">{{ url.latest_crawl.status_code }}</span>
                                            {% elif url.latest_crawl.status_code %}
                                                <span class="badge bg-danger">{{ url.latest_crawl.status_code }}</span>
                                            {% else %}
                                                <span class="badge bg-secondary">-</span>
                                            {% endif %}
                                        {% else %}
                                            <span class="badge bg-secondary">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <a href="{{ url_for('url_detail', url_id=url.id) }}" 
                                               class="btn btn-outline-info" title="View Details">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <button type="button" class="btn btn-outline-danger" 
                                                    onclick="deleteUrl({{ url.id }}, '{{ url.url|truncate(30) }}')"
                                                    title="Delete">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination -->
                    {% if urls.pages > 1 %}
                        <nav class="mt-4">
                            <ul class="pagination justify-content-center">
                                {% if urls.has_prev %}
                                    <li class="page-item">
                                        <a class="page-link" href="{{ url_for('urls', page=urls.prev_num, status=current_status, q=search_query) }}">
                                            <i class="fas fa-chevron-left"></i>
                                        </a>
                                    </li>
                                {% endif %}
                                
                                {% for page_num in urls.iter_pages() %}
                                    {% if page_num %}
                                        {% if page_num != urls.page %}
                                            <li class="page-item">
                                                <a class="page-link" href="{{ url_for('urls', page=page_num, status=current_status, q=search_query) }}">
                                                    {{ page_num }}
                                                </a>
                                            </li>
                                        {% else %}
                                            <li class="page-item active">
                                                <span class="page-link">{{ page_num }}</span>
                                            </li>
                                        {% endif %}
                                    {% else %}
                                        <li class="page-item disabled">
                                            <span class="page-link">...</span>
                                        </li>
                                    {% endif %}
                                {% endfor %}
                                
                                {% if urls.has_next %}
                                    <li class="page-item">
                                        <a class="page-link" href="{{ url_for('urls', page=urls.next_num, status=current_status, q=search_query) }}">
                                            <i class="fas fa-chevron-right"></i>
                                        </a>
                                    </li>
                                {% endif %}
                            </ul>
                        </nav>
                    {% endif %}
                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-link fa-3x text-muted mb-3"></i>
                        <h5>No URLs Found</h5>
                        <p class="text-muted">
                            {% if search_query %}
                                No URLs match your search criteria.
                            {% elif current_status %}
                                No URLs with {{ current_status }} status.
                            {% else %}
                                Get started by adding your first URL.
                            {% endif %}
                        </p>
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addUrlModal">
                            <i class="fas fa-plus me-1"></i>
                            Add Your First URL
                        </button>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Add URL Modal -->
<div class="modal fade" id="addUrlModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('add_url') }}">
                <div class="modal-header">
                    <h5 class="modal-title">Add URL</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="url" class="form-label">URL</label>
                        <input type="url" class="form-control" id="url" name="url" 
                               placeholder="https://example.com/page" required>
                        <div class="form-text">Enter a complete URL including http:// or https://</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add URL</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Bulk Add Modal -->
<div class="modal fade" id="bulkAddModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('bulk_add_urls') }}">
                <div class="modal-header">
                    <h5 class="modal-title">Bulk Add URLs</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="urls" class="form-label">URLs (one per line)</label>
                        <textarea class="form-control" id="urls" name="urls" rows="10" 
                                  placeholder="https://example.com/page1&#10;https://example.com/page2&#10;https://example.com/page3" required></textarea>
                        <div class="form-text">Enter one URL per line. Invalid URLs will be skipped.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add URLs</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Discover URLs Modal -->
<div class="modal fade" id="discoverModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('discover_urls_route') }}">
                <div class="modal-header">
                    <h5 class="modal-title">Discover URLs</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="source" class="form-label">Source Type</label>
                        <select class="form-select" id="source" name="source" onchange="updateSourceFields()">
                            <option value="sitemap">XML Sitemap</option>
                            <option value="rss">RSS/Atom Feed</option>
                            <option value="webpage">Webpage Links</option>
                            <option value="robots">robots.txt</option>
                            <option value="crawl">Website Crawl</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="source_url" class="form-label">Source URL</label>
                        <input type="url" class="form-control" id="source_url" name="source_url" 
                               placeholder="https://example.com/sitemap.xml" required>
                        <div class="form-text" id="source-help">
                            Enter the URL of the XML sitemap to discover URLs from.
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Discover URLs</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // Select all checkbox functionality
    document.getElementById('selectAll').addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('.url-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
    });
    
    // Update source fields based on selection
    function updateSourceFields() {
        const source = document.getElementById('source').value;
        const urlField = document.getElementById('source_url');
        const helpText = document.getElementById('source-help');
        
        switch(source) {
            case 'sitemap':
                urlField.placeholder = 'https://example.com/sitemap.xml';
                helpText.textContent = 'Enter the URL of the XML sitemap to discover URLs from.';
                break;
            case 'rss':
                urlField.placeholder = 'https://example.com/feed.xml';
                helpText.textContent = 'Enter the URL of the RSS or Atom feed.';
                break;
            case 'webpage':
                urlField.placeholder = 'https://example.com/';
                helpText.textContent = 'Enter the URL of the webpage to extract links from.';
                break;
            case 'robots':
                urlField.placeholder = 'https://example.com/';
                helpText.textContent = 'Enter the base URL to check robots.txt for sitemaps.';
                break;
            case 'crawl':
                urlField.placeholder = 'https://example.com/';
                helpText.textContent = 'Enter the starting URL for crawling (limited depth).';
                break;
        }
    }
    
    // Delete URL function
    function deleteUrl(urlId, urlText) {
        if (confirm(`Are you sure you want to delete this URL?\n\n${urlText}`)) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/delete-url/${urlId}`;
            document.body.appendChild(form);
            form.submit();
        }
    }
    
    // Auto-refresh page every 2 minutes if there are pending URLs
    {% if status_counts.pending > 0 %}
        setTimeout(() => {
            window.location.reload();
        }, 120000);
    {% endif %}
</script>
{% endblock %}
